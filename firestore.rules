
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    // Checks if the user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Checks if the user is an admin, supervisor, or secretary.
    function isStaff() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Admin', 'Supervisor', 'Secretary'];
    }
    
    // Checks if the user is a specific role
    function isRole(role) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // Checks if the user is the owner of the document.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- Collections ---

    // USERS: Staff can read all users. Admins can manage users. Users can read/update their own profile.
    match /users/{userId} {
      allow read: if isStaff() || isOwner(userId);
      allow update: if isOwner(userId) || isRole('Admin');
      allow create: if isSignedIn(); // Allow any signed-up user to have a profile created.
      allow delete: if isRole('Admin');
    }
    
    // CUSTOMERS: Staff can manage all customer profiles.
    match /customers/{customerId} {
      allow read, create, update, delete: if isStaff();
    }
    
    // VEHICLES: Public can read, only staff can write.
    match /vehicles/{vehicleId} {
      allow read: if true;
      allow create, update, delete: if isStaff();
    }
    
    // RESERVATIONS: Staff can manage all. Authenticated users can create them. Users can read their own.
    match /reservations/{reservationId} {
      allow read, update, delete: if isStaff() || (isSignedIn() && resource.data.customerId == request.auth.uid);
      allow create: if isSignedIn();
    }
    
    // REVIEWS: Public can read. Authenticated users can create. Admins/Supervisors can manage.
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isRole('Admin') || isRole('Supervisor');
    }

    // INVOICES, EXPENSES, MAINTENANCE: Staff only.
    match /invoices/{invoiceId} {
      allow read, create, update, delete: if isStaff();
    }
    
    match /expenses/{expenseId} {
      allow read, create, update, delete: if isStaff();
    }

    match /maintenanceLogs/{logId} {
      allow read, create, update, delete: if isStaff();
    }

    // DOCUMENTS & CONTRACTS: Staff only.
    match /documents/{documentId} {
        allow read, create, update, delete: if isStaff();
    }
    match /contracts/{contractId} {
        allow read, create, update, delete: if isStaff();
    }

    // ACTIVITY LOGS: Staff can read, any authenticated user action can create one.
    match /activityLogs/{logId} {
      allow read: if isStaff();
      allow create: if isSignedIn();
    }
  }
}
