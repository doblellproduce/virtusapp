rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    // Checks if the user is a staff member (Admin, Supervisor, or Secretary)
    function isStaff() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Admin', 'Supervisor', 'Secretary'];
    }
    
    // Checks if the user is a top-level Admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    // --- COLLECTION RULES ---

    // USERS: Staff can manage. Users can manage their own profile.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isStaff();
      // Admins can create new staff users from the panel.
      allow create, delete: if isAdmin();
    }
    
    // CUSTOMERS: Staff manage customer profiles.
    match /customers/{customerId} {
      // Staff can perform all operations on customer documents.
      allow read, create, update, delete: if isStaff();
    }

    // VEHICLES: Public read, staff write access.
    match /vehicles/{vehicleId} {
      allow read: if true;
      allow create, update, delete: if isStaff();
    }

    // RESERVATIONS: Staff manage all.
    match /reservations/{reservationId} {
      // All operations are restricted to staff members.
      allow read, create, update, delete: if isStaff();
    }
    
    // INVOICES & EXPENSES: Full access for staff.
    match /invoices/{invoiceId} {
       allow read, create, update, delete: if isStaff();
    }
    match /expenses/{expenseId} {
       allow read, create, update, delete: if isStaff();
    }

    // REVIEWS: Public read. Management for staff.
    match /reviews/{reviewId} {
      allow read: if true;
      // Staff can create reviews (e.g., on behalf of a customer).
      allow create, update, delete: if isStaff();
    }

    // MAINTENANCE, CONTRACTS, ACTIVITY LOGS: Staff management.
    match /maintenanceLogs/{logId} {
       allow read, create, update, delete: if isStaff();
    }
    match /contracts/{contractId} {
        allow read, create, update, delete: if isStaff();
    }
    match /activityLogs/{logId} {
      // Staff can read and write to the activity log.
      allow read, create: if isStaff();
    }
  }
}