rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    // Checks if the user is a staff member (Admin, Supervisor, or Secretary)
    function isStaff() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Admin', 'Supervisor', 'Secretary'];
    }
    
    // Checks if the user is a top-level Admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    // --- COLLECTION RULES ---

    // USERS: Staff can manage. Users can manage their own profile.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isStaff();
      // Admins can create new staff users from the panel.
      allow create, delete: if isAdmin();
    }
    
    // CUSTOMERS: Only staff can manage and create customers now.
    match /customers/{customerId} {
      allow read, create, update, delete: if isStaff();
    }

    // VEHICLES: Public read, staff write access.
    match /vehicles/{vehicleId} {
      allow read: if true;
      allow create, update, delete: if isStaff();
    }

    // RESERVATIONS: Staff manage all.
    match /reservations/{reservationId} {
      allow read, create, update, delete: if isStaff();
    }
    
    // INVOICES, EXPENSES, ETC: Full access for staff.
    match /invoices/{invoiceId} {
       allow read, create, update, delete: if isStaff();
    }
    match /expenses/{expenseId} {
       allow read, create, update, delete: if isStaff();
    }
    match /reviews/{reviewId} {
      allow read: if true;
      // Staff can create reviews on behalf of customers
      allow create, update, delete: if isStaff();
    }
    match /maintenanceLogs/{logId} {
       allow read, create, update, delete: if isStaff();
    }
    match /contracts/{contractId} {
        allow read, create, update, delete: if isStaff();
    }
    match /documents/{documentId} {
        allow read, create, update, delete: if isStaff();
    }
    match /activityLogs/{logId} {
      // Allow any authenticated staff member to write logs.
      allow create, read: if isStaff();
    }
  }
}
