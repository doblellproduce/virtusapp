rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Función auxiliar para verificar si el usuario es un miembro del personal
    function isStaff() {
      return get(/databases/(default)/documents/users/$(request.auth.uid)).data.role in ['Admin', 'Supervisor', 'Secretary'];
    }

    // Las imágenes de los vehículos son de lectura pública para que cualquiera pueda ver la flota.
    // Solo el personal puede subir o eliminar imágenes de vehículos.
    match /vehicles/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && isStaff();
    }

    // Las fotos de inspección y las firmas solo pueden ser creadas por el personal (durante la inspección).
    // Y solo pueden ser leídas por el personal.
    match /inspections/{allPaths=**} {
      allow read, write: if request.auth != null && isStaff();
    }
    match /signatures/{allPaths=**} {
      allow read, write: if request.auth != null && isStaff();
    }

    // Los documentos cargados (licencias, etc.) solo pueden ser manejados por el personal.
    match /documents/{allPaths=**} {
       allow read, write: if request.auth != null && isStaff();
    }
  }
}
